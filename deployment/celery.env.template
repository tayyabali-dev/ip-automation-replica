# Celery Worker Environment Configuration Template
# Copy this file to backend/.env.celery and update the values for your environment
# Note: This can also be merged with backend/.env if running on the same server

# =============================================================================
# CELERY WORKER CONFIGURATION
# =============================================================================

# Worker Identity
CELERY_WORKER_NAME=worker@%h
CELERY_WORKER_LOGLEVEL=info
CELERY_WORKER_CONCURRENCY=4
CELERY_WORKER_PREFETCH_MULTIPLIER=1

# Worker Queues
CELERY_WORKER_QUEUES=default,document_processing,office_action,report_generation
CELERY_WORKER_ROUTES={
    'app.tasks.document_extraction': {'queue': 'document_processing'},
    'app.tasks.office_action_processing': {'queue': 'office_action'},
    'app.tasks.report_generation': {'queue': 'report_generation'}
}

# Worker Pool Configuration
CELERY_WORKER_POOL=prefork
CELERY_WORKER_MAX_TASKS_PER_CHILD=1000
CELERY_WORKER_MAX_MEMORY_PER_CHILD=200000

# =============================================================================
# REDIS BROKER CONFIGURATION
# =============================================================================

# Redis Connection
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=
REDIS_SSL=false

# Celery Broker Settings
CELERY_BROKER_URL=redis://localhost:6379/0
CELERY_RESULT_BACKEND=redis://localhost:6379/0

# Broker Connection Pool
CELERY_BROKER_POOL_LIMIT=10
CELERY_BROKER_CONNECTION_RETRY=true
CELERY_BROKER_CONNECTION_RETRY_ON_STARTUP=true
CELERY_BROKER_CONNECTION_MAX_RETRIES=3

# Result Backend Configuration
CELERY_RESULT_EXPIRES=3600
CELERY_RESULT_PERSISTENT=true
CELERY_RESULT_COMPRESSION=gzip

# =============================================================================
# TASK CONFIGURATION
# =============================================================================

# Task Serialization
CELERY_TASK_SERIALIZER=json
CELERY_RESULT_SERIALIZER=json
CELERY_ACCEPT_CONTENT=["json"]

# Task Execution
CELERY_TASK_ALWAYS_EAGER=false
CELERY_TASK_EAGER_PROPAGATES=true
CELERY_TASK_IGNORE_RESULT=false
CELERY_TASK_STORE_EAGER_RESULT=true

# Task Routing
CELERY_TASK_DEFAULT_QUEUE=default
CELERY_TASK_DEFAULT_EXCHANGE=default
CELERY_TASK_DEFAULT_EXCHANGE_TYPE=direct
CELERY_TASK_DEFAULT_ROUTING_KEY=default

# Task Time Limits
CELERY_TASK_SOFT_TIME_LIMIT=300
CELERY_TASK_TIME_LIMIT=600
CELERY_TASK_ACKS_LATE=true
CELERY_TASK_REJECT_ON_WORKER_LOST=true

# =============================================================================
# MONITORING CONFIGURATION
# =============================================================================

# Worker Monitoring
CELERY_WORKER_SEND_TASK_EVENTS=true
CELERY_TASK_SEND_SENT_EVENT=true
CELERY_WORKER_HIJACK_ROOT_LOGGER=false

# Event Monitoring
CELERY_WORKER_ENABLE_REMOTE_CONTROL=true
CELERY_WORKER_SEND_TASK_EVENTS=true

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================

# Log Configuration
CELERY_WORKER_LOG_FORMAT=[%(asctime)s: %(levelname)s/%(processName)s] %(message)s
CELERY_WORKER_TASK_LOG_FORMAT=[%(asctime)s: %(levelname)s/%(processName)s][%(task_name)s(%(task_id)s)] %(message)s

# Log Files
CELERY_WORKER_LOGFILE=./logs/celery.log
CELERY_WORKER_PIDFILE=./logs/celery.pid

# =============================================================================
# DOCUMENT PROCESSING CONFIGURATION
# =============================================================================

# Document Processing Tasks
DOCUMENT_PROCESSING_TIMEOUT=300
DOCUMENT_PROCESSING_RETRY_DELAY=60
DOCUMENT_PROCESSING_MAX_RETRIES=3

# File Processing
MAX_FILE_SIZE=10485760
ALLOWED_FILE_EXTENSIONS=[".pdf", ".docx", ".doc"]
TEMP_DIR=./temp
UPLOAD_DIR=./uploads

# OCR Configuration
ENABLE_OCR=true
OCR_LANGUAGE=eng
PDF_DPI=300

# =============================================================================
# AI/ML SERVICES CONFIGURATION
# =============================================================================

# Google Gemini API
GEMINI_API_KEY=your-gemini-api-key-here
GEMINI_MODEL=gemini-2.5-pro
GEMINI_MAX_TOKENS=2048
GEMINI_TEMPERATURE=0.1
GEMINI_TIMEOUT=30

# OpenAI API (if using as fallback)
OPENAI_API_KEY=
OPENAI_MODEL=gpt-3.5-turbo
OPENAI_MAX_TOKENS=2048
OPENAI_TIMEOUT=30

# =============================================================================
# OFFICE ACTION PROCESSING
# =============================================================================

# Office Action Tasks
OFFICE_ACTION_PROCESSING_TIMEOUT=600
OFFICE_ACTION_RETRY_DELAY=120
OFFICE_ACTION_MAX_RETRIES=2

# Analysis Configuration
ENABLE_DETAILED_ANALYSIS=true
ANALYSIS_CONFIDENCE_THRESHOLD=0.8

# =============================================================================
# REPORT GENERATION
# =============================================================================

# Report Generation Tasks
REPORT_GENERATION_TIMEOUT=180
REPORT_GENERATION_RETRY_DELAY=30
REPORT_GENERATION_MAX_RETRIES=3

# Report Configuration
REPORT_FORMAT=pdf
REPORT_TEMPLATE_DIR=./templates
REPORT_OUTPUT_DIR=./reports

# =============================================================================
# DATABASE CONFIGURATION
# =============================================================================

# MongoDB Configuration (for task data access)
MONGODB_URL=mongodb://localhost:27017
MONGODB_DATABASE=jwhd_ip_automation
MONGODB_MIN_CONNECTIONS=5
MONGODB_MAX_CONNECTIONS=20

# Database Connection Pool
DB_POOL_SIZE=10
DB_MAX_OVERFLOW=15
DB_POOL_TIMEOUT=30

# =============================================================================
# EMAIL CONFIGURATION
# =============================================================================

# SMTP Configuration (for task notifications)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password
SMTP_TLS=true
SMTP_SSL=false

# Email Notifications
ENABLE_EMAIL_NOTIFICATIONS=false
EMAIL_FROM=noreply@jwhd-ip-automation.com
EMAIL_FROM_NAME="JWHD IP Automation Worker"

# =============================================================================
# PERFORMANCE CONFIGURATION
# =============================================================================

# Memory Management
CELERY_WORKER_MAX_MEMORY_PER_CHILD=200000
CELERY_WORKER_DISABLE_RATE_LIMITS=false

# Optimization
CELERY_OPTIMIZATION=fair
CELERY_WORKER_PREFETCH_MULTIPLIER=1
CELERY_WORKER_LOST_WAIT=10.0

# =============================================================================
# SECURITY CONFIGURATION
# =============================================================================

# Worker Security
CELERY_WORKER_HIJACK_ROOT_LOGGER=false
CELERY_WORKER_LOG_COLOR=false

# Task Security
CELERY_TASK_ANNOTATIONS={
    '*': {'rate_limit': '10/s'}
}

# =============================================================================
# INTER-SERVER COMMUNICATION
# =============================================================================

# Backend Server Details (for 4-server setup)
BACKEND_SERVER_HOST=localhost
BACKEND_SERVER_PORT=8000

# Redis Server Details
REDIS_SERVER_HOST=localhost
REDIS_SERVER_PORT=6379

# Frontend Server Details (for notifications)
FRONTEND_SERVER_HOST=localhost
FRONTEND_SERVER_PORT=3000

# =============================================================================
# DEVELOPMENT CONFIGURATION
# =============================================================================

# Development Settings
CELERY_WORKER_RELOAD=true
CELERY_WORKER_RELOAD_INCLUDES=["app.tasks", "app.services"]

# Debug Configuration
ENABLE_DEBUG_LOGGING=false
DEBUG_TASK_EXECUTION=false

# =============================================================================
# PRODUCTION CONFIGURATION
# =============================================================================

# Production Optimizations
CELERY_WORKER_DISABLE_RATE_LIMITS=false
CELERY_WORKER_ENABLE_HEARTBEATS=true

# Monitoring
ENABLE_WORKER_MONITORING=true
WORKER_HEALTH_CHECK_INTERVAL=60

# =============================================================================
# MULTI-SERVER DEPLOYMENT NOTES
# =============================================================================

# For 4-server deployment, update the following:
# 1. REDIS_HOST should point to the Redis server IP
# 2. CELERY_BROKER_URL should use the Redis server IP
# 3. CELERY_RESULT_BACKEND should use the Redis server IP
# 4. MONGODB_URL should point to accessible MongoDB instance
# 5. BACKEND_SERVER_HOST should be the actual backend server IP
# 6. Ensure all servers can communicate with each other

# Example for production 4-server setup:
# REDIS_HOST=192.168.1.102
# CELERY_BROKER_URL=redis://192.168.1.102:6379/0
# CELERY_RESULT_BACKEND=redis://192.168.1.102:6379/0
# BACKEND_SERVER_HOST=192.168.1.100
# MONGODB_URL=mongodb://192.168.1.100:27017

# =============================================================================
# QUEUE CONFIGURATION
# =============================================================================

# Queue Priorities
CELERY_TASK_ROUTES={
    'app.tasks.urgent_document_processing': {'queue': 'urgent'},
    'app.tasks.document_extraction': {'queue': 'document_processing'},
    'app.tasks.office_action_processing': {'queue': 'office_action'},
    'app.tasks.report_generation': {'queue': 'report_generation'},
    'app.tasks.cleanup_tasks': {'queue': 'maintenance'}
}

# Queue-specific Settings
CELERY_TASK_QUEUE_MAX_PRIORITY=10
CELERY_TASK_DEFAULT_PRIORITY=5

# =============================================================================
# SECURITY NOTES
# =============================================================================

# IMPORTANT:
# - Secure Redis connection with password in production
# - Use SSL/TLS for Redis connections in production
# - Implement proper network security between servers
# - Monitor worker performance and resource usage
# - Set appropriate task timeouts to prevent hanging tasks
# - Use environment-specific values for each deployment
# - Never commit actual secrets to version control